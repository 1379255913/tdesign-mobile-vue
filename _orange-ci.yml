install: &install
  - name: build cache image
    type: docker:cache
    options:
      dockerfile: cache.dockerfile
      by:
      - package.json
    exports:
      name: DOCKER_CACHE_IMAGE_NAME

develop:
  merge_request:
    - docker:
        image: node
      stages:
        - name: npm install
          script: npm install --legacy-peer-deps --registry=https://mirrors.tencent.com/npm/ --verbose

        - name: lint 检查
          script:
            - npm run lint

        - name: build
          script:
            - npm run build

$:
  tag_push:
    - stages:
      - *install
      - name: build
        image: $DOCKER_CACHE_IMAGE_NAME
        commands:
        - cp -r "$NODE_PATH" ./node_modules
        - npm run build
      - name: tnpm publish
        image: plugins/npm
        envFrom: https://git.code.oa.com/tdesign-private/private/blob/master/key/npm.txt
        settings:
          username: $TNPM_USERNAME
          password: $TNPM_PASSWORD
          email: $TNPM_EMAIL
          registry: http://r.tnpm.oa.com
          folder: ./

